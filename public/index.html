<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="mixer.css"/>
</head>
<body>
<audio id="mc" controls autoplay>
    <source src="/05%20-%20Hash%20Pipe.opus" type="audio/ogg">
</audio>
<ul>
    <li><a href="/05%20-%20Hash%20Pipe.opus" class="switch">05 - Hash Pipe</a></li>
    <li><a href="/09%20-%20Kids.opus" class="switch">09 - Kids</a></li>
</ul>
<div class="mixer">
    <div class="trackstrip">
        <div class="track" data-track="Drums">
            <div class="fader">
                <input type="range" min="0" max="1.8885" step="0.001" value="1.25">
            </div>
        </div>
        <div class="track" data-track="Bass">
            <div class="fader">
                <input type="range" min="0" max="1.8885" step="0.001" value="1.25">
            </div>
        </div>
        <div class="track" data-track="Guitar MG">
            <div class="fader">
                <input type="range" min="0" max="1.8885" step="0.001" value="1.25">
            </div>
        </div>
        <div class="track" data-track="Guitar JD">
            <div class="fader">
                <input type="range" min="0" max="1.8885" step="0.001" value="1.25">
            </div>
        </div>
        <div class="track" data-track="Vox MG">
            <div class="fader">
                <input type="range" min="0" max="1.8885" step="0.001" value="1.25">
            </div>
        </div>
        <div class="track" data-track="Vox JD">
            <div class="fader">
                <input type="range" min="0" max="1.8885" step="0.001" value="1.25">
            </div>
        </div>
    </div>
</div>
<script src="mixer.js"></script>
<script src="track.js"></script>
<script>
    let mixer = new Mixer();
    mixer.addTracks([
        {
            name: "Drums",
            channels: 2,
            level: 0
        },
        {
            name: "Bass",
            level: 0
        },
        {
            name: "Guitar MG",
            pan: -0.8,
            level: -2
        },
        {
            name: "Guitar JD",
            pan: +0.8,
            level: -2
        },
        {
            name: "Vox MG",
            pan: 0,
            level: 0
        },
        {
            name: "Vox JD",
            pan: +0.33,
            level: 0
        }
    ]);

    // Find out <audio> element:
    let mcAudio = document.getElementById("mc");
    const faderCenter = 1.25;

    // Wire up click handlers on links:
    document.querySelectorAll(".switch").forEach(
        el => el.addEventListener("click", e => {
            e.preventDefault();
            let href = e.target.getAttribute("href");
            mcAudio.src = href;
            mcAudio.play();
            return false;
        })
    );

    function faderByTrack(name) {
        return document.querySelector("div.track[data-track="+name+"] input[type=range]");
    }

    function faderInputHandler(el) {
        let trackEl = el.parentElement.parentElement;
        let trackName = trackEl.getAttribute("data-track");
        let track = mixer.track(trackName);

        let fader = el.value;
        fader = Math.pow(fader / faderCenter, 3.0);
        let dB = 20.0 * Math.log10(fader);
        //console.log(dB);
        track.level = dB;
    }

    document.querySelectorAll(".fader input[type=range]").forEach(
        el => {
            el.addEventListener("dblclick", e => {
                e.target.value = faderCenter;
                faderInputHandler(e.target);
            });
            el.addEventListener("input", e => faderInputHandler(e.target))
        }
    );

    // add an AudioContext
    let ac = new AudioContext();
    let mcSource = ac.createMediaElementSource(mcAudio);
    mcSource.channelCountMode = "explicit";
    mcSource.channelInterpretation = "discrete";

    // TODO: would be nice to detect channel count from source.
    let splitter = ac.createChannelSplitter(8);
    splitter.channelCountMode = "explicit";
    splitter.channelInterpretation = "discrete";
    mcSource.connect(splitter);

    // Create mixer FX chain:
    mixer.createNodes(ac);
    mixer.level = 6;
    // Connect mixer master out to destination:
    mixer.outputNode.connect(ac.destination);

    let c = 0;
    for (let track of mixer.tracks) {
        // Create track FX chain:
        track.createNodes(ac);

        // Connect media output to track input:
        let merger = ac.createChannelMerger(2);
        merger.channelCountMode = "explicit";
        merger.channelInterpretation = "discrete";

        if (track.channels == 2) {
            splitter.connect(merger, c++, 0);
            splitter.connect(merger, c++, 1);
        } else {
            splitter.connect(merger, c, 0);
            splitter.connect(merger, c, 1);
            c++;
        }
        merger.connect(track.inputNode);

        // Connect track FX chain to master output:
        track.outputNode.connect(mixer.inputNode);
    }
    mixer.applySolo();
</script>
</body>
</html>