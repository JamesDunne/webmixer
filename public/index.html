<!DOCTYPE html>
<html>
<head>

</head>
<body>
<audio id="mc" controls>
    <source src="/05%20-%20Hash%20Pipe.opus" type="audio/ogg">
</audio>
<script>
    class Mixer {
        constructor() {
            this._tracks = [];
        }

        addTracks(trackOpts) {
            this._tracks = this._tracks.concat(trackOpts.map(opts => new Track(this, opts)));
        }

        get tracks() {
            return this._tracks;
        }

        get anySoloedTracks() {
            return this._tracks.some(tr => tr.solo);
        }

        get unsoloedTracks() {
            return this._tracks.filter(tr => !tr.solo);
        }

        get soloedTracks() {
            return this._tracks.filter(tr => tr.solo);
        }
    }

    class Track {
        constructor(mixer, opts) {
            this.mixer = mixer;
            this.name = opts.name;
            this.channels = opts.channels;
            this._pan = opts.pan || 0;
            this._level = opts.level || 0;
            this._mute = opts.mute || false;
            this._solo = opts.solo || false;
            this._soloMute = false;
        }

        createNodes(ac) {
            // Create default nodes:
            this.soloMuteNode = ac.createGain();
            this.muteNode = ac.createGain();
            this.panLeftNode = ac.createGain();
            this.panRightNode = ac.createGain();
            this.postPanNode = ac.createChannelMerger(2);
            this.gainNode = ac.createGain();

            // Connect nodes:
            this.soloMuteNode.connect(this.muteNode);
            this.muteNode.connect(this.panLeftNode);
            this.muteNode.connect(this.panRightNode);
            this.panLeftNode.connect(this.postPanNode, 0, 0);
            this.panRightNode.connect(this.postPanNode, 0, 1);
            this.postPanNode.connect(this.gainNode);

            // Set properties:
            this.setSoloMute();
            this.setMute();
            this.setPan();
            this.setLevel();
        }

        get inputNode() {
            return this.soloMuteNode;
        }

        get outputNode() {
            return this.gainNode;
        }

        get pan() {
            return this._pan;
        }
        set pan(value) {
            this._pan = value;
            this.setPan();
        }
        setPan() {
            this.panLeftNode.gain.value = (this._pan * -0.5) + 0.5;
            this.panRightNode.gain.value = (this._pan * 0.5) + 0.5;
        }

        get level() {
            return this._level;
        }
        set level(value) {
            this._level = value;
            this.setLevel();
        }
        setLevel() {
            this.gainNode.gain.value = Math.pow(10.0, this._level / 20.0);
        }

        get mute() {
            return this._mute;
        }
        set mute(value) {
            this._mute = value;
            this.setMute();
        }
        setMute() {
            this.muteNode.gain.value = this._mute ? 0 : 1;
        }

        get solo() {
            return this._solo;
        }
        set solo(value) {
            this._solo = value;
            if (this.mixer.anySoloedTracks) {
                this.mixer.unsoloedTracks.forEach(tr => tr.soloMute = true);
                this.mixer.soloedTracks.forEach(tr => tr.soloMute = false);
            } else {
                this.mixer.tracks.forEach(tr => tr.soloMute = false);
            }
        }

        get soloMute() {
            return this._soloMute;
        }
        set soloMute(value) {
            this._soloMute = value;
            this.setSoloMute();
        }
        setSoloMute() {
            this.soloMuteNode.gain.value = this._soloMute ? 0 : 1;
        }
    }

    let mixer = new Mixer();
    mixer.addTracks([
        {
            name: "Drums",
            channels: 2,
            level: 0
        },
        {
            name: "Bass",
            channels: 1,
            level: 0
        },
        {
            name: "Guitar MG",
            channels: 1,
            pan: -0.8,
            level: 0
        },
        {
            name: "Guitar JD",
            channels: 1,
            pan: +0.8,
            level: 0
        },
        {
            name: "Vox MG",
            channels: 1,
            pan: 0,
            level: 0
        },
        {
            name: "Vox JD",
            channels: 1,
            pan: +0.33,
            level: 0
        }
    ]);

    // add an AudioContext
    let ac = new AudioContext();

    let mcAudio = document.getElementById("mc");
    let mcSource = ac.createMediaElementSource(mcAudio);

    // TODO: would be nice to detect channel count from source.
    let splitter = ac.createChannelSplitter(8);
    splitter.channelCountMode = "explicit";
    splitter.channelInterpretation = "discrete";
    mcSource.connect(splitter);

    let c = 0;
    for (let track of mixer.tracks) {
        // Merge outputs into channels:
        let merger = ac.createChannelMerger(track.channels);
        for (let i = 0; i < track.channels; i++) {
            splitter.connect(merger, c+i, i);
        }
        c += track.channels;

        // Create track FX chain:
        track.createNodes(ac);
        // Connect media source channels to track FX chain:
        merger.connect(track.inputNode);
        // Connect track FX chain to master output:
        track.outputNode.connect(ac.destination);
    }
</script>
</body>
</html>